const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
require('dotenv').config();

const authRoutes = require('./routes/auth');
const appraisalRoutes = require('./routes/appraisal');
const appointmentRoutes = require('./routes/appointment');
const pdfRoutes = require('./routes/pdf');
const leadRoutes = require('./routes/lead');
const aiRoutes = require('./routes/ai');
const googleRoutes = require('./routes/google');

const app = express();
const PORT = process.env.PORT || 3000;

// â¶ å…ˆã«helmet/corsã ã‘ï¼ˆâ†OKï¼‰
app.use(helmet());
app.use(cors());

// LINE Botè¨­å®š
const line = require('@line/bot-sdk');
const lineConfig = {
  channelAccessToken: process.env.LINE_CHANNEL_ACCESS_TOKEN,
  channelSecret: process.env.LINE_CHANNEL_SECRET
};
const lineClient = (lineConfig.channelAccessToken && lineConfig.channelSecret)
  ? new line.Client(lineConfig)
  : null;

// ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨­å®š
async function setupRichMenu() {
  if (!lineClient) return;
  
  try {
    // æ—¢å­˜ã®ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å‰Šé™¤
    const existingMenus = await lineClient.getRichMenuList();
    for (const menu of existingMenus) {
      await lineClient.deleteRichMenu(menu.richMenuId);
    }
    
    // æ–°ã—ã„ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä½œæˆ
    const richMenu = {
      size: {
        width: 2500,
        height: 843
      },
      selected: false,
      name: "ä¸å‹•ç”£æŸ»å®šã‚·ã‚¹ãƒ†ãƒ ",
      chatBarText: "ãƒ¡ãƒ‹ãƒ¥ãƒ¼",
      areas: [
        {
          bounds: {
            x: 0,
            y: 0,
            width: 625,
            height: 843
          },
          action: {
            type: "message",
            text: "ğŸ  æŸ»å®šé–‹å§‹"
          }
        },
        {
          bounds: {
            x: 625,
            y: 0,
            width: 625,
            height: 843
          },
          action: {
            type: "message",
            text: "ğŸ“… ç›¸è«‡äºˆç´„"
          }
        },
        {
          bounds: {
            x: 1250,
            y: 0,
            width: 625,
            height: 843
          },
          action: {
            type: "message",
            text: "â„¹ï¸ ãƒ˜ãƒ«ãƒ—"
          }
        },
        {
          bounds: {
            x: 1875,
            y: 0,
            width: 625,
            height: 843
          },
          action: {
            type: "message",
            text: "ğŸ”„ ã‚„ã‚Šç›´ã—"
          }
        }
      ]
    };
    
    const richMenuId = await lineClient.createRichMenu(richMenu);
    await lineClient.setDefaultRichMenu(richMenuId);
    console.log('âœ… ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¨­å®šã•ã‚Œã¾ã—ãŸ');
    
  } catch (error) {
    console.error('âŒ ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼:', error);
  }
}

// â¸ /webhook ã¯ body-parser ã‚ˆã‚Š"å…ˆ"ã«å®šç¾©ã™ã‚‹
if (lineClient) {
  app.post('/webhook', line.middleware(lineConfig), async (req, res) => {
    // æ¤œè¨¼ï¼ˆevents: []ï¼‰ã§ã‚‚ 200 ã‚’å³è¿”ã™
    if (!req.body.events || req.body.events.length === 0) {
      console.log('ğŸ“± LINE Webhook ping (empty events)');
      return res.status(200).end();
    }

    try {
      await Promise.all(req.body.events.map(handleEvent));
      return res.status(200).end(); // 200å›ºå®šã§OK
    } catch (err) {
      console.error('LINE Bot error:', err);
      // ã‚¨ãƒ©ãƒ¼ã§ã‚‚200ã§çµ‚ã‚ã‚‰ã›ã‚‹ã¨å†é€ãƒ«ãƒ¼ãƒ—ã‚’é¿ã‘ã‚‰ã‚Œã‚‹
      return res.status(200).end();
    }
  });

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
  const userSessions = new Map();

  async function handleEvent(event) {
    if (event.type === 'message' && event.message.type === 'text') {
      const userMessage = event.message.text;
      const userId = event.source.userId;
      console.log(`ğŸ“± LINEå—ä¿¡: ${userId} -> ${userMessage}`);

      try {
        const response = await handleConversation(userId, userMessage);
        // æ–‡å­—åˆ—ã®å ´åˆã¯ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦é€ä¿¡
        const message = typeof response === 'string' 
          ? { type: 'text', text: response }
          : response;
        return lineClient.replyMessage(event.replyToken, message);
      } catch (error) {
        console.error('LINE Botå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        return lineClient.replyMessage(event.replyToken, { 
          type: 'text', 
          text: 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚' 
        });
      }
    }
    return Promise.resolve(null);
  }

  // ä¼šè©±ãƒ•ãƒ­ãƒ¼ã®ç®¡ç†
  async function handleConversation(userId, userMessage) {
    let session = userSessions.get(userId);
    
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯åˆæœŸåŒ–
    if (!session) {
      session = {
        step: 'welcome',
        data: {},
        lastActivity: Date.now()
      };
      userSessions.set(userId, session);
    }
    
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒã‚§ãƒƒã‚¯ï¼ˆ30åˆ†ï¼‰
    if (Date.now() - session.lastActivity > 30 * 60 * 1000) {
      session = {
        step: 'welcome',
        data: {},
        lastActivity: Date.now()
      };
      userSessions.set(userId, session);
    }
    
    // æœ€å¾Œã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’æ›´æ–°
    session.lastActivity = Date.now();
    
    console.log(`ğŸ¤– ä¼šè©±ã‚¹ãƒ†ãƒƒãƒ—: ${session.step}, ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${userMessage}`);
    console.log(`ğŸ“Š ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿:`, session.data);

    try {
      switch (session.step) {
        case 'welcome':
          return handleWelcomeStep(userId, userMessage, session);
        
        case 'address':
          return handleAddressStep(userId, userMessage, session);
        
        case 'area':
          return handleAreaStep(userId, userMessage, session);
        
        case 'age':
          return handleAgeStep(userId, userMessage, session);
        
        case 'purpose':
          return handlePurposeStep(userId, userMessage, session);
        
        case 'name_input':
          return handleNameInputStep(userId, userMessage, session);
        
        case 'phone_input':
          return handlePhoneInputStep(userId, userMessage, session);
        
        case 'email_input':
          return handleEmailInputStep(userId, userMessage, session);
        
        case 'personal_info':
          return handlePersonalInfoStep(userId, userMessage, session);
        
        case 'result':
          return handleResultStep(userId, userMessage, session);
        
        case 'detailed_view':
          return handleDetailedViewStep(userId, userMessage, session);
        
        case 'next_action':
          return handleNextActionStep(userId, userMessage, session);
        
        case 'appointment':
          return handleAppointmentStep(userId, userMessage, session);
        
        case 'followup_setting':
          return handleFollowupSettingStep(userId, userMessage, session);
        
        default:
          session.step = 'welcome';
          return handleWelcomeStep(userId, userMessage, session);
      }
    } catch (error) {
      console.error('ä¼šè©±å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
      return 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
    }
  }

  // åå‰å…¥åŠ›ã‚¹ãƒ†ãƒƒãƒ—
  function handleNameInputStep(userId, message, session) {
    if (message.includes('ã‚„ã‚Šç›´ã—')) {
      session.step = 'purpose';
      return `ğŸ¯ ç”¨é€”ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã‹ã‚‰ãŠé¸ã³ãã ã•ã„ï¼š
â€¢ å£²å´
â€¢ è³¼å…¥
â€¢ è³ƒè²¸

ã©ã®ã‚ˆã†ãªç›®çš„ã§æŸ»å®šã‚’ã”å¸Œæœ›ã§ã—ã‚‡ã†ã‹ï¼Ÿ`;
    }
    
    if (message.length < 2) {
      return `ğŸ‘¤ ã‚‚ã†å°‘ã—è©³ã—ã„ãŠåå‰ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

ä¾‹ï¼šå±±ç”°å¤ªéƒã€ä½è—¤èŠ±å­

ã‚‚ã†å°‘ã—è©³ã—ãæ•™ãˆã¦ã„ãŸã ã‘ã‚‹ã¨åŠ©ã‹ã‚Šã¾ã™ã€‚`;
    }
    
    // åå‰ã‚’ä¿å­˜ã—ã¦æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€
    session.data.name = message;
    session.step = 'phone_input';
    userSessions.set(userId, session);
    
    console.log(`âœ… åå‰ä¿å­˜: ${message}, ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°: name_input â†’ phone_input`);
    
    return `ğŸ“± æ¬¡ã«**é›»è©±ç•ªå·**ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

ä¾‹ï¼š
â€¢ 090-1234-5678
â€¢ 080-9876-5432
â€¢ 03-1234-5678

é›»è©±ç•ªå·ã‚’ãŠæ•™ãˆãã ã•ã„ã€‚`;
  }

  // é›»è©±ç•ªå·å…¥åŠ›ã‚¹ãƒ†ãƒƒãƒ—
  function handlePhoneInputStep(userId, message, session) {
    if (message.includes('ã‚„ã‚Šç›´ã—')) {
      session.step = 'name_input';
      return `ğŸ‘¤ ãŠåå‰ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

ä¾‹ï¼šå±±ç”°å¤ªéƒã€ä½è—¤èŠ±å­

ãŠåå‰ã‚’ãŠæ•™ãˆãã ã•ã„ã€‚`;
    }
    
    // é›»è©±ç•ªå·ã®å½¢å¼ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“ç‰ˆï¼‰
    const phonePattern = /[\d\-\(\)\s]{10,}/;
    if (!phonePattern.test(message)) {
      return `ğŸ“± æ­£ã—ã„é›»è©±ç•ªå·ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

ä¾‹ï¼š
â€¢ 090-1234-5678
â€¢ 080-9876-5432
â€¢ 03-1234-5678

ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã­ã€‚`;
    }
    
    // é›»è©±ç•ªå·ã‚’ä¿å­˜ã—ã¦æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€
    session.data.phone = message;
    session.step = 'email_input';
    userSessions.set(userId, session);
    
    console.log(`âœ… é›»è©±ç•ªå·ä¿å­˜: ${message}, ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°: phone_input â†’ email_input`);
    
    return `ğŸ“§ æœ€å¾Œã«**ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹**ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

ä¾‹ï¼š
â€¢ example@email.com
â€¢ test123@gmail.com
â€¢ user@company.co.jp

ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãŠæ•™ãˆãã ã•ã„ã€‚
ï¼ˆå¿…é ˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹å ´åˆã¯ã€Œã‚¹ã‚­ãƒƒãƒ—ã€ã¨ãŠé€ã‚Šãã ã•ã„ï¼‰`;
  }

  // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›ã‚¹ãƒ†ãƒƒãƒ—
  function handleEmailInputStep(userId, message, session) {
    if (message.includes('ã‚„ã‚Šç›´ã—')) {
      session.step = 'phone_input';
      return `ğŸ“± é›»è©±ç•ªå·ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

ä¾‹ï¼š
â€¢ 090-1234-5678
â€¢ 080-9876-5432
â€¢ 03-1234-5678

é›»è©±ç•ªå·ã‚’ãŠæ•™ãˆãã ã•ã„ã€‚`;
    }
    
    if (message.includes('ã‚¹ã‚­ãƒƒãƒ—') || message.includes('skip')) {
      // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚¹ã‚­ãƒƒãƒ—
      session.data.email = null;
      console.log(`âœ… ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚¹ã‚­ãƒƒãƒ—, ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°: email_input â†’ personal_info`);
      
      // å€‹äººæƒ…å ±å…¥åŠ›å®Œäº†ã€è‡ªå‹•æŸ»å®šé–‹å§‹
      return completePersonalInfoAndStartAppraisal(userId, session);
    }
    
    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“ç‰ˆï¼‰
    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailPattern.test(message)) {
      return `ğŸ“§ æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

ä¾‹ï¼š
â€¢ example@email.com
â€¢ test123@gmail.com
â€¢ user@company.co.jp

ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã­ã€‚
ï¼ˆå¿…é ˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹å ´åˆã¯ã€Œã‚¹ã‚­ãƒƒãƒ—ã€ã¨ãŠé€ã‚Šãã ã•ã„ï¼‰`;
    }
    
    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¿å­˜
    session.data.email = message;
    console.log(`âœ… ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ä¿å­˜: ${message}, ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°: email_input â†’ personal_info`);
    
    // å€‹äººæƒ…å ±å…¥åŠ›å®Œäº†ã€è‡ªå‹•æŸ»å®šé–‹å§‹
    return completePersonalInfoAndStartAppraisal(userId, session);
  }

  // å€‹äººæƒ…å ±å…¥åŠ›å®Œäº†ã¨æŸ»å®šé–‹å§‹
  async function completePersonalInfoAndStartAppraisal(userId, session) {
    try {
      // Supabaseã«å€‹äººæƒ…å ±ã‚’ä¿å­˜
      const { supabaseAdmin } = require('./config/database');
      const { data: owner, error } = await supabaseAdmin
        .from('owners')
        .upsert({
          line_user_id: userId,
          name: session.data.name,
          phone: session.data.phone,
          email: session.data.email,
          consent_given: true,
          last_activity: new Date().toISOString()
        }, {
          onConflict: 'line_user_id'
        })
        .select()
        .single();

      if (error) {
        console.error('å€‹äººæƒ…å ±ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        return `âŒ ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚å€‹äººæƒ…å ±ã®ä¿å­˜ã«å¤±æ•—ã„ãŸã—ã¾ã—ãŸã€‚

ã‚‚ã†ä¸€åº¦æœ€åˆã‹ã‚‰å…¥åŠ›ã—ã¦ã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ã€‚
ã€Œã‚„ã‚Šç›´ã—ã€ã¨ãŠé€ã‚Šãã ã•ã„ã€‚`;
      }

      console.log('âœ… å€‹äººæƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ:', owner.id);
      
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«å€‹äººæƒ…å ±ã‚’ä¿å­˜
      session.data.owner_id = owner.id;
      session.step = 'result';
      
      // è‡ªå‹•çš„ã«æŸ»å®šã‚’é–‹å§‹
      try {
        console.log(`ğŸ¤– è‡ªå‹•æŸ»å®šé–‹å§‹: ${session.data.address}`);
        
        // å®Ÿéš›ã®æŸ»å®šAPIã‚’å‘¼ã³å‡ºã—
        const appraisalResult = await executeAppraisal(session.data);
        session.data.result = appraisalResult;
        userSessions.set(userId, session);
        
        return `âœ… å€‹äººæƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼

ğŸ¤– AIæŸ»å®šã‚’é–‹å§‹ã„ãŸã—ã¾ã™ï¼

${session.data.address}ã®${session.data.area}ã¡ã€ç¯‰${session.data.age}å¹´ã®ç‰©ä»¶ã‚’${session.data.purpose}ç›®çš„ã§æŸ»å®šã„ãŸã—ã¾ã™ã€‚

ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã­...

ğŸ“Š æŸ»å®šå®Œäº†ã„ãŸã—ã¾ã—ãŸï¼

${appraisalResult.summary}

è©³ç´°ãªçµæœã‚’ã”è¦§ã«ãªã‚ŠãŸã„å ´åˆã¯ã€Œè©³ç´°è¡¨ç¤ºã€ã¨ãŠé€ã‚Šãã ã•ã„ã€‚
ç›¸è«‡äºˆç´„ã‚’ã”å¸Œæœ›ã®å ´åˆã¯ã€Œäºˆç´„ã—ãŸã„ã€ã¨ãŠé€ã‚Šãã ã•ã„ã€‚
ã‚„ã‚Šç›´ã—ã®å ´åˆã¯ã€Œã‚„ã‚Šç›´ã—ã€ã¨ãŠé€ã‚Šãã ã•ã„ã€‚`;
        
      } catch (error) {
        console.error('æŸ»å®šã‚¨ãƒ©ãƒ¼:', error);
        session.step = 'result';
        userSessions.set(userId, session);
        return `âœ… å€‹äººæƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼

âŒ ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚æŸ»å®šå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã„ãŸã—ã¾ã—ãŸã€‚

ã‚‚ã†ä¸€åº¦æŸ»å®šã‚’é–‹å§‹ã™ã‚‹ã«ã¯ã€Œã‚„ã‚Šç›´ã—ã€ã¨ãŠé€ã‚Šãã ã•ã„ã€‚`;
      }
      
    } catch (error) {
      console.error('å€‹äººæƒ…å ±ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      return `âŒ ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚å€‹äººæƒ…å ±ã®ä¿å­˜ã«å¤±æ•—ã„ãŸã—ã¾ã—ãŸã€‚

ã‚‚ã†ä¸€åº¦æœ€åˆã‹ã‚‰å…¥åŠ›ã—ã¦ã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ã€‚
ã€Œã‚„ã‚Šç›´ã—ã€ã¨ãŠé€ã‚Šãã ã•ã„ã€‚`;
    }
  }

  // ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  function getWelcomeMessage() {
    return `ğŸ  äºŒå®®ä¸å‹•ç”£æŸ»å®šã‚·ã‚¹ãƒ†ãƒ ã¸ã‚ˆã†ã“ãï¼

ä¸å‹•ç”£ã®ä¾¡å€¤ã‚’AIãŒåˆ†æã—ã€é©æ­£ä¾¡æ ¼ã‚’ãŠç­”ãˆã—ã¾ã™ã€‚

ã¾ãšã¯ç°¡å˜ãªè³ªå•ã«ãŠç­”ãˆãã ã•ã„ã€‚
æœ€åˆã«ã€ŒæŸ»å®šé–‹å§‹ã€ã¨ãŠé€ã‚Šãã ã•ã„ã€‚

ğŸ“‹ æŸ»å®šã«å¿…è¦ãªæƒ…å ±ï¼š
â€¢ ä½æ‰€
â€¢ é¢ç©ï¼ˆã¡ï¼‰
â€¢ ç¯‰å¹´æ•°
â€¢ ç”¨é€”ï¼ˆå£²å´ãƒ»è³¼å…¥ãƒ»è³ƒè²¸ï¼‰

ä½•ã‹ã”è³ªå•ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠèã‹ã›ãã ã•ã„ã€‚`;
  }

    // ã‚¦ã‚§ãƒ«ã‚«ãƒ ã‚¹ãƒ†ãƒƒãƒ—
    function handleWelcomeStep(userId, message, session) {
      if (message.includes('æŸ»å®šé–‹å§‹') || message.includes('æŸ»å®š') || message.includes('é–‹å§‹')) {
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒƒãƒ—ã‚’ç¢ºå®Ÿã«æ›´æ–°
        session.step = 'address';
        session.data = {}; // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
        userSessions.set(userId, session); // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿å­˜
        
        console.log(`âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°: welcome â†’ address`);
        
        return `ğŸ“ ã¾ãšã¯ç‰©ä»¶ã®ä½æ‰€ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

ä¾‹ï¼š
â€¢ æ±äº¬éƒ½æ–°å®¿åŒºè¥¿æ–°å®¿1-1-1
â€¢ å¤§é˜ªå¸‚åŒ—åŒºæ¢…ç”°1-1-1
â€¢ æ¨ªæµœå¸‚è¥¿åŒºã¿ãªã¨ã¿ã‚‰ã„1-1-1

ãŠä½ã¾ã„ã®ä½æ‰€ã€ã‚‚ã—ãã¯æŸ»å®šã—ãŸã„ç‰©ä»¶ã®ä½æ‰€ã‚’æ•™ãˆã¦ãã ã•ã„ã­ã€‚`;
      }
      
      if (message.includes('äºˆç´„') || message.includes('ç›¸è«‡')) {
        return handleAppointmentRequest(userId, message);
      }

      return `æŸ»å®šã‚’é–‹å§‹ã™ã‚‹ã«ã¯ã€ŒæŸ»å®šé–‹å§‹ã€ã¨ãŠé€ã‚Šãã ã•ã„ã€‚

ã¾ãŸã¯ã€ç›¸è«‡äºˆç´„ã‚’ã”å¸Œæœ›ã®å ´åˆã¯ã€Œäºˆç´„ã—ãŸã„ã€ã¨ãŠé€ã‚Šãã ã•ã„ã€‚`;
    }

    // ä½æ‰€ã‚¹ãƒ†ãƒƒãƒ—
    function handleAddressStep(userId, message, session) {
      if (message.length < 5) {
        return `ğŸ“ ã‚‚ã†å°‘ã—è©³ã—ã„ä½æ‰€ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

ä¾‹ï¼šæ±äº¬éƒ½æ–°å®¿åŒºè¥¿æ–°å®¿1-1-1

ã‚‚ã†å°‘ã—è©³ã—ãæ•™ãˆã¦ã„ãŸã ã‘ã‚‹ã¨ã€ã‚ˆã‚Šæ­£ç¢ºãªæŸ»å®šãŒã§ãã¾ã™ã‚ˆã€‚`;
      }

      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
      session.data.address = message;
      session.step = 'area';
      userSessions.set(userId, session); // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿å­˜
      
      console.log(`âœ… ä½æ‰€ä¿å­˜: ${message}, ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°: address â†’ area`);
      
      return `ğŸ“ æ¬¡ã«ç‰©ä»¶ã®é¢ç©ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

ä¾‹ï¼š
â€¢ 70ã¡
â€¢ 100ã¡
â€¢ 50ã¡

æ•°å­—ã ã‘ã§å¤§ä¸ˆå¤«ã§ã™ã€‚ãŠæ°—è»½ã«ãŠç­”ãˆãã ã•ã„ã­ã€‚`;
    }

    // é¢ç©ã‚¹ãƒ†ãƒƒãƒ—
    function handleAreaStep(userId, message, session) {
      const area = parseInt(message);
      if (isNaN(area) || area < 10 || area > 1000) {
        return `ğŸ“ æ­£ã—ã„é¢ç©ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

ä¾‹ï¼š70ã€100ã€50

10ã¡ã€œ1000ã¡ã®ç¯„å›²ã§ã€æ•°å­—ã ã‘ã§å¤§ä¸ˆå¤«ã§ã™ã€‚
ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã­ã€‚`;
      }

      session.data.area = area;
      session.step = 'age';
      return `ğŸ—ï¸ æ¬¡ã«ç¯‰å¹´æ•°ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

ä¾‹ï¼š
â€¢ 10å¹´
â€¢ æ–°ç¯‰
â€¢ ç¯‰20å¹´

ãŠä½ã¾ã„ã®ç¯‰å¹´æ•°ã€ã‚‚ã—ãã¯ç¯‰å¹´æ•°ã‚’ãŠæ•™ãˆãã ã•ã„ã­ã€‚`;
    }

    // ç¯‰å¹´æ•°ã‚¹ãƒ†ãƒƒãƒ—
    function handleAgeStep(userId, message, session) {
      let age;
      if (message.includes('æ–°ç¯‰') || message.includes('0å¹´')) {
        age = 0;
      } else {
        age = parseInt(message.replace(/[^0-9]/g, ''));
        if (isNaN(age) || age < 0 || age > 100) {
          return `ğŸ—ï¸ æ­£ã—ã„ç¯‰å¹´æ•°ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

ä¾‹ï¼š10å¹´ã€æ–°ç¯‰ã€ç¯‰20å¹´

ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã­ã€‚`;
        }
      }

      session.data.age = age;
      session.step = 'purpose';
      return `ğŸ¯ æœ€å¾Œã«ç”¨é€”ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã‹ã‚‰ãŠé¸ã³ãã ã•ã„ï¼š
â€¢ å£²å´
â€¢ è³¼å…¥
â€¢ è³ƒè²¸

ã©ã®ã‚ˆã†ãªç›®çš„ã§æŸ»å®šã‚’ã”å¸Œæœ›ã§ã—ã‚‡ã†ã‹ï¼Ÿ`;
    }

    // ç”¨é€”ã‚¹ãƒ†ãƒƒãƒ—
    function handlePurposeStep(userId, message, session) {
      let purpose;
      if (message.includes('å£²å´')) {
        purpose = 'å£²å´';
      } else if (message.includes('è³¼å…¥')) {
        purpose = 'è³¼å…¥';
      } else if (message.includes('è³ƒè²¸')) {
        purpose = 'è³ƒè²¸';
      } else {
        return `ğŸ¯ ç”¨é€”ã‚’æ­£ã—ãé¸æŠã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã‚’ãŠé¸ã³ãã ã•ã„ï¼š
â€¢ å£²å´
â€¢ è³¼å…¥
â€¢ è³ƒè²¸

ç”¨é€”ã‚’ãŠæ•™ãˆãã ã•ã„ã€‚`;
      }

      session.data.purpose = purpose;
      session.step = 'name_input';
      return `ğŸ‘¤ å€‹äººæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ã„ãŸã ãã¾ã™ã­ã€‚

ã¾ãšã¯**ãŠåå‰**ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

ä¾‹ï¼š
â€¢ å±±ç”°å¤ªéƒ
â€¢ ä½è—¤èŠ±å­
â€¢ ç”°ä¸­ä¸€éƒ

ãŠåå‰ã‚’ãŠæ•™ãˆãã ã•ã„ã€‚`;
    }

  // å€‹äººæƒ…å ±å…¥åŠ›ã‚¹ãƒ†ãƒƒãƒ—
  async function handlePersonalInfoStep(userId, message, session) {
    if (message.includes('ã‚„ã‚Šç›´ã—')) {
      session.step = 'purpose';
      return `ğŸ‘¤ å€‹äººæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚

ä¾‹ï¼š
â€¢ åå‰: å±±ç”°å¤ªéƒ
â€¢ é›»è©±ç•ªå·: 090-1234-5678
â€¢ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: example@example.com

ã“ã‚Œã‚‰ã®æƒ…å ±ã¯æŸ»å®šçµæœã®ã¿ã«ä½¿ç”¨ã•ã‚Œã€ç¬¬ä¸‰è€…ã«ã¯å…¬é–‹ã•ã‚Œã¾ã›ã‚“ã€‚`;
    }

    // å€‹äººæƒ…å ±ã®è§£æ
    const personalInfo = parsePersonalInfo(message);
    
    if (!personalInfo.name || !personalInfo.phone) {
      return `âŒ åå‰ã¨é›»è©±ç•ªå·ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚

ä¾‹ï¼š
â€¢ åå‰: å±±ç”°å¤ªéƒ
â€¢ é›»è©±ç•ªå·: 090-1234-5678

ã‚‚ã†ä¸€åº¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`;
    }

    try {
      // Supabaseã«å€‹äººæƒ…å ±ã‚’ä¿å­˜
      const { supabaseAdmin } = require('./config/database');
      const { data: owner, error } = await supabaseAdmin
        .from('owners')
        .upsert({
          line_user_id: userId,
          name: personalInfo.name,
          phone: personalInfo.phone,
          email: personalInfo.email || null,
          consent_given: true,
          last_activity: new Date().toISOString()
        }, {
          onConflict: 'line_user_id'
        })
        .select()
        .single();

      if (error) {
        console.error('å€‹äººæƒ…å ±ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        return 'âŒ å€‹äººæƒ…å ±ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
      }

      console.log('âœ… å€‹äººæƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ:', owner.id);
      
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«å€‹äººæƒ…å ±ã‚’ä¿å­˜
      session.data.owner_id = owner.id;
      session.data.personalInfo = personalInfo;
      
      // å€‹äººæƒ…å ±å…¥åŠ›å®Œäº†å¾Œã€è‡ªå‹•çš„ã«æŸ»å®šã‚’é–‹å§‹
      try {
        console.log(`ğŸ¤– è‡ªå‹•æŸ»å®šé–‹å§‹: ${session.data.address}`);
        
        // å®Ÿéš›ã®æŸ»å®šAPIã‚’å‘¼ã³å‡ºã—
        const appraisalResult = await executeAppraisal(session.data);
        session.data.result = appraisalResult;
        session.step = 'result';
        
        return `âœ… å€‹äººæƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼

ğŸ¤– AIæŸ»å®šã‚’é–‹å§‹ã„ãŸã—ã¾ã™ï¼

${session.data.address}ã®${session.data.area}ã¡ã€ç¯‰${session.data.age}å¹´ã®ç‰©ä»¶ã‚’${session.data.purpose}ç›®çš„ã§æŸ»å®šã„ãŸã—ã¾ã™ã€‚

ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã­...

ğŸ“Š æŸ»å®šå®Œäº†ã„ãŸã—ã¾ã—ãŸï¼

${appraisalResult.summary}

è©³ç´°ãªçµæœã‚’ã”è¦§ã«ãªã‚ŠãŸã„å ´åˆã¯ã€Œè©³ç´°è¡¨ç¤ºã€ã¨ãŠé€ã‚Šãã ã•ã„ã€‚
ç›¸è«‡äºˆç´„ã‚’ã”å¸Œæœ›ã®å ´åˆã¯ã€Œäºˆç´„ã—ãŸã„ã€ã¨ãŠé€ã‚Šãã ã•ã„ã€‚
ã‚„ã‚Šç›´ã—ã®å ´åˆã¯ã€Œã‚„ã‚Šç›´ã—ã€ã¨ãŠé€ã‚Šãã ã•ã„ã€‚`;
        
      } catch (error) {
        console.error('æŸ»å®šã‚¨ãƒ©ãƒ¼:', error);
        session.step = 'result';
        return `âœ… å€‹äººæƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼

âŒ ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚æŸ»å®šå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã„ãŸã—ã¾ã—ãŸã€‚

ã‚‚ã†ä¸€åº¦æŸ»å®šã‚’é–‹å§‹ã™ã‚‹ã«ã¯ã€Œã‚„ã‚Šç›´ã—ã€ã¨ãŠé€ã‚Šãã ã•ã„ã€‚`;
      }
      
    } catch (error) {
      console.error('å€‹äººæƒ…å ±ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      return 'âŒ å€‹äººæƒ…å ±ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
    }
  }

  // å€‹äººæƒ…å ±ã®è§£æ
  function parsePersonalInfo(message) {
    const info = {
      name: null,
      phone: null,
      email: null
    };

    // åå‰ã®æŠ½å‡º
    const nameMatch = message.match(/åå‰[ï¼š:]\s*([^\n\r]+)/);
    if (nameMatch) {
      info.name = nameMatch[1].trim();
    }

    // é›»è©±ç•ªå·ã®æŠ½å‡º
    const phoneMatch = message.match(/é›»è©±ç•ªå·[ï¼š:]\s*([^\n\r]+)/);
    if (phoneMatch) {
      info.phone = phoneMatch[1].trim();
    }

    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®æŠ½å‡º
    const emailMatch = message.match(/ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹[ï¼š:]\s*([^\n\r]+)/);
    if (emailMatch) {
      info.email = emailMatch[1].trim();
    }

    return info;
  }

    // æŸ»å®šå®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—
    async function handleAppraisalStep(userId, message, session) {
      if (!message.includes('æŸ»å®šå®Ÿè¡Œ')) {
        return `ã€ŒæŸ»å®šå®Ÿè¡Œã€ã¨ãŠé€ã‚Šãã ã•ã„ã€‚

ã¾ãŸã¯ã€æƒ…å ±ã‚’ä¿®æ­£ã—ãŸã„å ´åˆã¯ã€Œã‚„ã‚Šç›´ã—ã€ã¨ãŠé€ã‚Šãã ã•ã„ã€‚`;
      }

      try {
        // å®Ÿéš›ã®æŸ»å®šAPIã‚’å‘¼ã³å‡ºã—
        const appraisalResult = await executeAppraisal(session.data);
        session.data.result = appraisalResult;
        session.step = 'result';
        
        return `ğŸ“Š æŸ»å®šå®Œäº†ï¼

${appraisalResult.summary}

è©³ç´°ãªçµæœã‚’è¦‹ã‚‹ã«ã¯ã€Œè©³ç´°è¡¨ç¤ºã€ã¨ãŠé€ã‚Šãã ã•ã„ã€‚
ç›¸è«‡äºˆç´„ã‚’ã”å¸Œæœ›ã®å ´åˆã¯ã€Œäºˆç´„ã—ãŸã„ã€ã¨ãŠé€ã‚Šãã ã•ã„ã€‚
ã‚„ã‚Šç›´ã—ã®å ´åˆã¯ã€Œã‚„ã‚Šç›´ã—ã€ã¨ãŠé€ã‚Šãã ã•ã„ã€‚`;

      } catch (error) {
        console.error('æŸ»å®šã‚¨ãƒ©ãƒ¼:', error);
        session.step = 'purpose';
        return `ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚æŸ»å®šå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

ã‚‚ã†ä¸€åº¦ç”¨é€”ã‹ã‚‰ãŠç­”ãˆãã ã•ã„ã€‚
ç”¨é€”ã‚’ãŠæ•™ãˆãã ã•ã„ã€‚`;
      }
    }

  // æŸ»å®šå®Ÿè¡Œï¼ˆå®Ÿéš›ã®APIå‘¼ã³å‡ºã—ï¼‰
  async function executeAppraisal(data) {
    try {
      console.log(`ğŸ¤– æŸ»å®šé–‹å§‹: ${data.address}`);
      
      // 1. å›½äº¤ç›¸APIã§è¿‘å‚ç‰©ä»¶ãƒ‡ãƒ¼ã‚¿å–å¾—
      const reinfolibData = await fetchReinfolibData(data.address);
      console.log(`ğŸ“Š å›½äº¤ç›¸ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†: ${reinfolibData.length}ä»¶`);
      
      // 2. è¿‘å‚è£œæ­£é©ç”¨
      const correctedData = await applyNearbyCorrection(data, reinfolibData);
      console.log(`ğŸ”§ è¿‘å‚è£œæ­£å®Œäº†: ${correctedData.length}ä»¶`);
      
      // 3. AIäºˆæ¸¬å®Ÿè¡Œ
      const aiPrediction = await executeAIPrediction(data, correctedData);
      console.log(`ğŸ¤– AIäºˆæ¸¬å®Œäº†: ${aiPrediction.price_range || 'ä¾¡æ ¼è¨ˆç®—ä¸­'}`);
      
      // 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
      await saveAppraisalToDatabase(data, reinfolibData, correctedData, aiPrediction);
      console.log(`ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜å®Œäº†`);
      
      // 5. çµæœã‚’æ•´å½¢
      return formatAppraisalResult(data, reinfolibData, correctedData, aiPrediction);
      
    } catch (error) {
      console.error('æŸ»å®šå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
      
      // ã‚¨ãƒ©ãƒ¼æ™‚ã¯åŸºæœ¬çš„ãªæƒ…å ±ã®ã¿è¿”ã™
      return {
        summary: `ğŸ  æŸ»å®šçµæœï¼š${data.address}

ğŸ“Š æ¨å®šä¾¡æ ¼ï¼šè¨ˆç®—ä¸­...
ğŸ¯ ç”¨é€”ï¼š${data.purpose}
ğŸ“ é¢ç©ï¼š${data.area}ã¡
ğŸ—ï¸ ç¯‰å¹´æ•°ï¼š${data.age === 0 ? 'æ–°ç¯‰' : `ç¯‰${data.age}å¹´`}

ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚è©³ç´°ãªæŸ»å®šã«ã¯æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚
å¾Œã»ã©æ”¹ã‚ã¦ãŠç­”ãˆã„ãŸã—ã¾ã™ã€‚`,
        detailed: `ğŸ“Š æŸ»å®šå‡¦ç†çŠ¶æ³

ğŸ  ç‰©ä»¶æƒ…å ±
â€¢ ä½æ‰€ï¼š${data.address}
â€¢ é¢ç©ï¼š${data.area}ã¡
â€¢ ç¯‰å¹´æ•°ï¼š${data.age === 0 ? 'æ–°ç¯‰' : `ç¯‰${data.age}å¹´`}
â€¢ ç”¨é€”ï¼š${data.purpose}

âš ï¸ ç¾åœ¨ã®çŠ¶æ³
â€¢ æŸ»å®šå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ
â€¢ ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã«ç¢ºèªä¸­ã§ã™
â€¢ å¾Œã»ã©æ”¹ã‚ã¦è©³ç´°ãªæŸ»å®šçµæœã‚’ãŠé€ã‚Šã—ã¾ã™

ã”ä¸ä¾¿ã‚’ãŠã‹ã‘ã—ã¦ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚`
      };
    }
  }

  // å›½äº¤ç›¸APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
  async function fetchReinfolibData(address) {
    try {
      const axios = require('axios');
      const apiKey = process.env.REINFOLIB_API_KEY;
      
      if (!apiKey) {
        console.log('âš ï¸ å›½äº¤ç›¸APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return generateMockReinfolibData(address);
      }

      // ä½æ‰€ã‹ã‚‰éƒ½é“åºœçœŒã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡º
      const prefectureCode = extractPrefectureCode(address);
      
      // å›½äº¤ç›¸APIå‘¼ã³å‡ºã—ï¼ˆXIT001: å–å¼•ä¾¡æ ¼æƒ…å ±ï¼‰
      const response = await axios.get(
        `https://www.reinfolib.mlit.go.jp/ex-api/external/XIT001`,
        {
          params: {
            year: new Date().getFullYear(),
            area: prefectureCode,
            priceClassification: '01'
          },
          headers: {
            'Ocp-Apim-Subscription-Key': apiKey,
            'Accept': 'application/json',
            'Accept-Encoding': 'gzip'
          },
          timeout: 15000
        }
      );

      if (response.data && response.data.data) {
        return response.data.data;
      } else {
        console.log('âš ï¸ å›½äº¤ç›¸APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
        return generateMockReinfolibData(address);
      }
      
    } catch (error) {
      console.error('å›½äº¤ç›¸APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error.message);
      return generateMockReinfolibData(address);
    }
  }

  // ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆä½æ‰€ã«å¿œã˜ãŸï¼‰
  function generateMockReinfolibData(address) {
    const basePrice = getBasePriceByAddress(address);
    const mockData = [];
    
    for (let i = 0; i < 10; i++) {
      const age = Math.floor(Math.random() * 30) + 1;
      const area = Math.floor(Math.random() * 100) + 50;
      const price = Math.floor(basePrice * (area / 100) * (1 - age * 0.01) * (0.8 + Math.random() * 0.4));
      
      mockData.push({
        price: price,
        area: area,
        age: age,
        address: `${address}å‘¨è¾º`,
        transaction_date: new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000).toISOString()
      });
    }
    
    return mockData;
  }

    // ä½æ‰€ã«å¿œã˜ãŸåŸºæœ¬ä¾¡æ ¼è¨­å®šï¼ˆã¡å˜ä¾¡ï¼‰
    function getBasePriceByAddress(address) {
      if (address.includes('æ±äº¬éƒ½') || address.includes('æ±äº¬')) {
        return 800000; // 80ä¸‡å††/ã¡
      } else if (address.includes('å¤§é˜ªåºœ') || address.includes('å¤§é˜ªå¸‚')) {
        return 500000; // 50ä¸‡å††/ã¡
      } else if (address.includes('æ„›çŸ¥çœŒ') || address.includes('åå¤å±‹å¸‚')) {
        return 400000; // 40ä¸‡å††/ã¡
      } else if (address.includes('ç¦å²¡çœŒ') || address.includes('ç¦å²¡å¸‚')) {
        return 350000; // 35ä¸‡å††/ã¡
      } else if (address.includes('åºƒå³¶çœŒ') || address.includes('åºƒå³¶å¸‚')) {
        return 150000; // 15ä¸‡å††/ã¡ï¼ˆä¿®æ­£ï¼š20ä¸‡å††â†’15ä¸‡å††ï¼‰
      } else if (address.includes('å®®åŸçœŒ') || address.includes('ä»™å°å¸‚')) {
        return 120000; // 12ä¸‡å††/ã¡ï¼ˆä¿®æ­£ï¼š18ä¸‡å††â†’12ä¸‡å††ï¼‰
      } else if (address.includes('åŒ—æµ·é“') || address.includes('æœ­å¹Œå¸‚')) {
        return 100000; // 10ä¸‡å††/ã¡ï¼ˆä¿®æ­£ï¼š15ä¸‡å††â†’10ä¸‡å††ï¼‰
      } else {
        return 80000; // 8ä¸‡å††/ã¡ï¼ˆä¿®æ­£ï¼š12ä¸‡å††â†’8ä¸‡å††ï¼‰
      }
    }

  // éƒ½é“åºœçœŒã‚³ãƒ¼ãƒ‰æŠ½å‡º
  function extractPrefectureCode(address) {
    if (!address || typeof address !== 'string') {
      return '13'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šæ±äº¬
    }
    
    if (address.includes('æ±äº¬éƒ½') || address.includes('æ±äº¬')) return '13';
    if (address.includes('å¤§é˜ªåºœ') || address.includes('å¤§é˜ª')) return '27';
    if (address.includes('æ„›çŸ¥çœŒ') || address.includes('åå¤å±‹')) return '23';
    if (address.includes('ç¦å²¡çœŒ') || address.includes('ç¦å²¡')) return '40';
    if (address.includes('åºƒå³¶çœŒ') || address.includes('åºƒå³¶')) return '34';
    if (address.includes('å®®åŸçœŒ') || address.includes('ä»™å°')) return '04';
    if (address.includes('åŒ—æµ·é“') || address.includes('æœ­å¹Œ')) return '01';
    
    return '13'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šæ±äº¬
  }

  // è¿‘å‚è£œæ­£é©ç”¨
  async function applyNearbyCorrection(data, reinfolibData) {
    try {
      if (!reinfolibData || reinfolibData.length === 0) {
        return [];
      }

      // é¡ä¼¼ç‰©ä»¶ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const similarProperties = reinfolibData.filter(prop => {
        const areaDiff = Math.abs(prop.area - data.area) / data.area;
        const ageDiff = Math.abs(prop.age - data.age);
        
        return areaDiff <= 0.3 && ageDiff <= 10; // é¢ç©30%ä»¥å†…ã€ç¯‰å¹´æ•°10å¹´ä»¥å†…
      });

      // é¡ä¼¼ç‰©ä»¶ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å…¨ä»¶ä½¿ç”¨
      const targetProperties = similarProperties.length > 0 ? similarProperties : reinfolibData;
      
      // ä¾¡æ ¼è£œæ­£è¨ˆç®—
      return targetProperties.map(prop => {
        const areaCorrection = data.area / prop.area;
        const ageCorrection = Math.max(0.7, 1 - (data.age - prop.age) * 0.01);
        
        return {
          ...prop,
          corrected_price: Math.floor(prop.price * areaCorrection * ageCorrection),
          correction_factors: {
            area: areaCorrection,
            age: ageCorrection
          }
        };
      });
      
    } catch (error) {
      console.error('è¿‘å‚è£œæ­£ã‚¨ãƒ©ãƒ¼:', error);
      return reinfolibData || [];
    }
  }

  // AIäºˆæ¸¬å®Ÿè¡Œ
  async function executeAIPrediction(data, correctedData) {
    try {
      const axios = require('axios');
      const apiKey = process.env.OPENAI_API_KEY;
      
      if (!apiKey) {
        console.log('âš ï¸ OpenAI APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return generateMockAIPrediction(data, correctedData);
      }

      // ç‰¹å¾´é‡æŠ½å‡º
      const features = extractFeatures(data, correctedData);
      
      // OpenAI APIå‘¼ã³å‡ºã—
      const response = await axios.post(
        'https://api.openai.com/v1/chat/completions',
        {
          model: 'gpt-3.5-turbo',
          messages: [
            {
              role: 'system',
              content: 'ã‚ãªãŸã¯ä¸å‹•ç”£æŸ»å®šã®å°‚é–€å®¶ã§ã™ã€‚ä¸ãˆã‚‰ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’åŸºã«ã€ç¾å®Ÿçš„ãªä¾¡æ ¼ç¯„å›²ã¨æ ¹æ‹ ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚100ã¡ã®ç‰©ä»¶ã§1å„„å††ã‚’è¶…ãˆã‚‹ä¾¡æ ¼ã¯ç¾å®Ÿçš„ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'
            },
            {
              role: 'user',
              content: `ä»¥ä¸‹ã®ç‰©ä»¶æƒ…å ±ã¨è¿‘å‚å–å¼•ãƒ‡ãƒ¼ã‚¿ã‚’åŸºã«ã€ç¾å®Ÿçš„ãªé©æ­£ä¾¡æ ¼ã‚’ç®—å‡ºã—ã¦ãã ã•ã„ã€‚

ç‰©ä»¶æƒ…å ±ï¼š
- ä½æ‰€ï¼š${data.address}
- é¢ç©ï¼š${data.area}ã¡
- ç¯‰å¹´æ•°ï¼š${data.age === 0 ? 'æ–°ç¯‰' : `${data.age}å¹´`}
- ç”¨é€”ï¼š${data.purpose}

è¿‘å‚å–å¼•ãƒ‡ãƒ¼ã‚¿ï¼ˆ${correctedData.length}ä»¶ï¼‰ï¼š
${correctedData.slice(0, 5).map(prop => 
  `- ${prop.address}å‘¨è¾º: ${prop.corrected_price}ä¸‡å†† (${prop.area}ã¡, ç¯‰${prop.age}å¹´)`
).join('\n')}

ç‰¹å¾´é‡ï¼š
${Object.entries(features).map(([key, value]) => `- ${key}: ${value}`).join('\n')}

**é‡è¦**: 100ã¡ã®ç‰©ä»¶ã§1å„„å††ã‚’è¶…ãˆã‚‹ä¾¡æ ¼ã¯ç¾å®Ÿçš„ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ä»¥ä¸‹ã®å½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ï¼š
{
  "price_range": "ä¾¡æ ¼ç¯„å›²ï¼ˆä¾‹ï¼š1,500ä¸‡å††ã€œ2,000ä¸‡å††ï¼‰",
  "price_per_sqm": "ã¡å˜ä¾¡ï¼ˆä¾‹ï¼š15ä¸‡å††ã€œ20ä¸‡å††ï¼‰",
  "market_trend": "å¸‚å ´å‹•å‘ï¼ˆä¾‹ï¼šå®‰å®šï¼‰",
  "confidence": "ä¿¡é ¼åº¦ï¼ˆä¾‹ï¼šä¸­ï¼‰",
  "reasoning": "æ ¹æ‹ ï¼ˆä¾‹ï¼šè¿‘å‚ç‰©ä»¶ã®å¹³å‡ä¾¡æ ¼ã¨ç‰¹å¾´é‡ã‚’è€ƒæ…®ï¼‰"
}`
            }
          ],
          max_tokens: 500,
          temperature: 0.3
        },
        {
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          }
        }
      );

      if (response.data && response.data.choices && response.data.choices[0]) {
        const content = response.data.choices[0].message.content;
        const parsedResult = parseAIResponse(content, data, correctedData);
        
        // å¤ã„å½¢å¼ã‚’æ–°ã—ã„å½¢å¼ã«å¤‰æ›
        const convertedResult = convertToNewFormat(parsedResult, data, correctedData);
        
        // ä¾¡æ ¼ã®å¦¥å½“æ€§ã‚’æœ€çµ‚ãƒã‚§ãƒƒã‚¯
        if (convertedResult.price_high_yen > data.area * 500000) {
          console.log('âš ï¸ AIäºˆæ¸¬çµæœãŒç¾å®Ÿçš„ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨');
          return generateMockAIPrediction(data, correctedData);
        }
        
        return convertedResult;
      } else {
        throw new Error('AI APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒä¸æ­£ã§ã™');
      }
      
    } catch (error) {
      console.error('AIäºˆæ¸¬ã‚¨ãƒ©ãƒ¼:', error.message);
      return generateMockAIPrediction(data, correctedData);
    }
  }

  // å¤ã„å½¢å¼ã‚’æ–°ã—ã„å½¢å¼ã«å¤‰æ›
  function convertToNewFormat(oldFormat, data, correctedData) {
    console.log('ğŸ”„ å¤ã„å½¢å¼ã‚’æ–°ã—ã„å½¢å¼ã«å¤‰æ›ä¸­:', oldFormat);
    
    // ä¾¡æ ¼ç¯„å›²ã‹ã‚‰æ•°å€¤ã‚’æŠ½å‡ºï¼ˆã‚ˆã‚Šå³å¯†ãªè§£æï¼‰
    let lowYen, highYen;
    
    if (oldFormat.price_range) {
      // ãƒ‘ã‚¿ãƒ¼ãƒ³1: "9,500ä¸‡å††ã€œ11,500ä¸‡å††" ã®ã‚ˆã†ãªå½¢å¼
      const pattern1 = oldFormat.price_range.match(/(\d+(?:,\d+)?)(?:å„„)?ä¸‡å††[ã€œ~](\d+(?:,\d+)?)(?:å„„)?ä¸‡å††/);
      if (pattern1) {
        const low = parseFloat(pattern1[1].replace(/,/g, ''));
        const high = parseFloat(pattern1[2].replace(/,/g, ''));
        
        if (oldFormat.price_range.includes('å„„')) {
          lowYen = Math.round(low * 100000000);
          highYen = Math.round(high * 100000000);
        } else {
          lowYen = Math.round(low * 10000);
          highYen = Math.round(high * 10000);
        }
        console.log('âœ… ãƒ‘ã‚¿ãƒ¼ãƒ³1ã§è§£ææˆåŠŸ:', { low, high, lowYen, highYen });
      }
      
      // ãƒ‘ã‚¿ãƒ¼ãƒ³2: "9500ä¸‡å††ã€œ11500ä¸‡å††" ã®ã‚ˆã†ãªå½¢å¼ï¼ˆã‚«ãƒ³ãƒãªã—ï¼‰
      if (!lowYen) {
        const pattern2 = oldFormat.price_range.match(/(\d+)(?:å„„)?ä¸‡å††[ã€œ~](\d+)(?:å„„)?ä¸‡å††/);
        if (pattern2) {
          const low = parseFloat(pattern2[1]);
          const high = parseFloat(pattern2[2]);
          
          if (oldFormat.price_range.includes('å„„')) {
            lowYen = Math.round(low * 100000000);
            highYen = Math.round(high * 100000000);
          } else {
            lowYen = Math.round(low * 10000);
            highYen = Math.round(high * 10000);
          }
          console.log('âœ… ãƒ‘ã‚¿ãƒ¼ãƒ³2ã§è§£ææˆåŠŸ:', { low, high, lowYen, highYen });
        }
      }
    }
    
    // æ•°å€¤ãŒæŠ½å‡ºã§ããªã„å ´åˆã€ã¾ãŸã¯ç¾å®Ÿçš„ã§ãªã„ä¾¡æ ¼ã®å ´åˆã¯ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
    if (!lowYen || !highYen || isNaN(lowYen) || isNaN(highYen)) {
      console.log('âš ï¸ ä¾¡æ ¼ç¯„å›²ã®è§£æã«å¤±æ•—ã€ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨');
      return generateMockAIPrediction(data, correctedData);
    }
    
    // ä¾¡æ ¼ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆ100ã¡ã§1å„„å††è¶…ã¯ç•°å¸¸ï¼‰
    const maxReasonablePrice = data.area * 500000; // 50ä¸‡å††/ã¡ã‚’ä¸Šé™ã¨ã™ã‚‹
    if (highYen > maxReasonablePrice) {
      console.log('âš ï¸ ä¾¡æ ¼ãŒç¾å®Ÿçš„ã§ã¯ã‚ã‚Šã¾ã›ã‚“:', { highYen, maxReasonablePrice });
      console.log('ğŸ”„ ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨');
      return generateMockAIPrediction(data, correctedData);
    }
    
    // ã¡å˜ä¾¡ã‚’è¨ˆç®—
    const basePricePerSqm = getBasePriceByAddress(data.address);
    const ageFactor = data.age === 0 ? 1.2 : 
                     data.age <= 5 ? 1.15 : 
                     data.age <= 10 ? 1.1 : 
                     data.age <= 20 ? 1.0 : 
                     data.age <= 30 ? 0.9 : 0.8;
    const marketFactor = 0.9 + Math.random() * 0.2;
    const adjYenPerM2 = Math.round(basePricePerSqm * ageFactor * marketFactor);
    
    const manPerM2 = Math.round((adjYenPerM2 / 10000) * 10) / 10;
    const manPerTsubo = Math.round((adjYenPerM2 * 3.305785 / 10000) * 10) / 10;
    
    const newFormat = {
      price_low_yen: lowYen,
      price_high_yen: highYen,
      unit_man_per_m2: manPerM2,
      unit_man_per_tsubo: manPerTsubo,
      market_trend: oldFormat.market_trend || 'å®‰å®š',
      confidence: oldFormat.confidence || 'ä¸­',
      reasoning: oldFormat.reasoning || 'è¿‘å‚å–å¼•ã®ä¸­å¤®å€¤ã¨ä¿‚æ•°è£œæ­£ã‚’åæ˜ ',
      nearby_count: correctedData.length,
      analysis_period: 'éå»1å¹´',
      radius: '2kmä»¥å†…',
      calculation_details: {
        base_price_per_sqm: Math.floor(basePricePerSqm / 10000),
        area_in_tsubo: data.area / 3.305785,
        age_factor: Math.round(ageFactor * 100) / 100,
        market_factor: Math.round(marketFactor * 100) / 100,
        adjusted_price_per_sqm: Math.floor(adjYenPerM2 / 10000)
      }
    };
    
    console.log('âœ… æ–°ã—ã„å½¢å¼ã«å¤‰æ›å®Œäº†:', newFormat);
    return newFormat;
  }

  // AIãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æ
  function parseAIResponse(content, data, correctedData) {
    try {
      // JSONéƒ¨åˆ†ã‚’æŠ½å‡º
      const jsonMatch = content.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        const parsed = JSON.parse(jsonMatch[0]);
        return {
          ...parsed,
          nearby_count: correctedData.length,
          analysis_period: 'éå»1å¹´',
          radius: '2kmä»¥å†…'
        };
      }
    } catch (error) {
      console.error('AIãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æã‚¨ãƒ©ãƒ¼:', error);
    }
    
    // ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ãŸå ´åˆã¯ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿
    return generateMockAIPrediction(data, correctedData);
  }

  // ç‰¹å¾´é‡æŠ½å‡º
  function extractFeatures(data, correctedData) {
    if (!Array.isArray(correctedData) || correctedData.length === 0) {
      return {
        'è¿‘å‚ç‰©ä»¶æ•°': 0,
        'å¹³å‡ä¾¡æ ¼': 'ãƒ‡ãƒ¼ã‚¿ãªã—',
        'ä¾¡æ ¼å¤‰å‹•': 'ãƒ‡ãƒ¼ã‚¿ãªã—'
      };
    }

    const prices = correctedData.map(prop => prop.corrected_price || prop.price);
    const avgPrice = Math.floor(prices.reduce((a, b) => a + b, 0) / prices.length);
    const priceVariance = Math.floor(Math.sqrt(
      prices.reduce((sum, price) => sum + Math.pow(price - avgPrice, 2), 0) / prices.length
    ));

    return {
      'è¿‘å‚ç‰©ä»¶æ•°': correctedData.length,
      'å¹³å‡ä¾¡æ ¼': `${avgPrice}ä¸‡å††`,
      'ä¾¡æ ¼å¤‰å‹•': `${priceVariance}ä¸‡å††`,
      'é¢ç©': `${data.area}ã¡`,
      'ç¯‰å¹´æ•°': data.age === 0 ? 'æ–°ç¯‰' : `${data.age}å¹´`,
      'ç”¨é€”': data.purpose
    };
  }

  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜
  async function saveAppraisalToDatabase(data, reinfolibData, correctedData, aiPrediction) {
    try {
      const { supabaseAdmin } = require('./config/database');
      
      if (!supabaseAdmin) {
        console.log('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
        return;
      }

      // 1. ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£æƒ…å ±ä¿å­˜
      const { data: property, error: propertyError } = await supabaseAdmin
        .from('properties')
        .insert({
          line_user_id: data.userId || 'unknown',
          address: data.address,
          area: data.area,
          age: data.age,
          purpose: data.purpose
        })
        .select()
        .single();

      if (propertyError) {
        console.error('ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ä¿å­˜ã‚¨ãƒ©ãƒ¼:', propertyError);
        return;
      }

      // 2. æŸ»å®šçµæœä¿å­˜
      const { error: appraisalError } = await supabaseAdmin
        .from('appraisals')
        .insert({
          user_id: data.userId || 'unknown',
          property_id: property.id,
          reinfolib_data: reinfolibData,
          corrected_data: correctedData,
          ai_prediction: aiPrediction
        });

      if (appraisalError) {
        console.error('æŸ»å®šçµæœä¿å­˜ã‚¨ãƒ©ãƒ¼:', appraisalError);
      }

      console.log('âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜å®Œäº†');
      
    } catch (error) {
      console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
    }
  }

      // æŸ»å®šçµæœãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆä¿®æ­£ç‰ˆï¼‰
    function formatAppraisalResult(data, reinfolibData, correctedData, aiPrediction) {
      const priceUtils = require('./utils/price-utils');
      
      console.log('ğŸ” è¡¨ç¤ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ‡ãƒãƒƒã‚°é–‹å§‹');
      console.log('ğŸ“Š aiPrediction:', aiPrediction);
      console.log('ğŸ’° ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿:', {
        price_low_yen: aiPrediction.price_low_yen,
        price_high_yen: aiPrediction.price_high_yen,
        type_low: typeof aiPrediction.price_low_yen,
        type_high: typeof aiPrediction.price_high_yen
      });
      
      // ä¾¡æ ¼ç¯„å›²ã‚’æ­£ã—ãè¡¨ç¤º
      const priceText = priceUtils.priceRangeText(aiPrediction.price_low_yen, aiPrediction.price_high_yen);
      console.log('ğŸ¯ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¾Œã®ä¾¡æ ¼ãƒ†ã‚­ã‚¹ãƒˆ:', priceText);
      
      const summary = `ğŸ  æŸ»å®šçµæœï¼š${data.address}

ğŸ“Š æ¨å®šä¾¡æ ¼ï¼š${priceText}
ğŸ¯ ç”¨é€”ï¼š${data.purpose}
ğŸ“ é¢ç©ï¼š${data.area}ã¡ï¼ˆ${priceUtils.m2ToTsubo(data.area).toFixed(2)}åªï¼‰
ğŸ—ï¸ ç¯‰å¹´æ•°ï¼š${data.age === 0 ? 'æ–°ç¯‰' : `ç¯‰${data.age}å¹´`}

ğŸ¤– AIåˆ†æã«ã‚ˆã‚‹æŸ»å®šçµæœã§ã™ã€‚
ğŸ“Š åˆ†æå¯¾è±¡ï¼š${reinfolibData.length}ä»¶ã®è¿‘å‚å–å¼•ãƒ‡ãƒ¼ã‚¿`;

      const detailed = `ğŸ“Š è©³ç´°åˆ†æçµæœ

ğŸ  ç‰©ä»¶æƒ…å ±
â€¢ ä½æ‰€ï¼š${data.address}
â€¢ é¢ç©ï¼š${data.area}ã¡ï¼ˆ${priceUtils.m2ToTsubo(data.area).toFixed(2)}åªï¼‰
â€¢ ç¯‰å¹´æ•°ï¼š${data.age === 0 ? 'æ–°ç¯‰' : `ç¯‰${data.age}å¹´`}
â€¢ ç”¨é€”ï¼š${data.purpose}

ğŸ’° ä¾¡æ ¼åˆ†æ
â€¢ æ¨å®šä¾¡æ ¼ï¼š${priceText}
â€¢ ã¡å˜ä¾¡ï¼š${aiPrediction.unit_man_per_m2}ä¸‡å††/ã¡
â€¢ åªå˜ä¾¡ï¼š${aiPrediction.unit_man_per_tsubo}ä¸‡å††/åª
â€¢ å¸‚å ´ç›¸å ´ï¼š${aiPrediction.market_trend}

ğŸ“ˆ å¸‚å ´å‹•å‘
â€¢ ä¾¡æ ¼ãƒˆãƒ¬ãƒ³ãƒ‰ï¼š${aiPrediction.market_trend}
â€¢ å–å¼•é‡ï¼šå®‰å®š
â€¢ éœ€è¦ï¼šé«˜

ğŸ” åˆ†æè©³ç´°
â€¢ è¿‘å‚ç‰©ä»¶æ•°ï¼š${aiPrediction.nearby_count}ä»¶
â€¢ åˆ†ææœŸé–“ï¼š${aiPrediction.analysis_period}
â€¢ åˆ†æç¯„å›²ï¼š${aiPrediction.radius}
â€¢ ä¿¡é ¼åº¦ï¼š${aiPrediction.confidence}

ğŸ§® è¨ˆç®—æ ¹æ‹ 
â€¢ åŸºæœ¬ã¡å˜ä¾¡ï¼š${aiPrediction.calculation_details?.base_price_per_sqm || 'N/A'}ä¸‡å††/ã¡
â€¢ é¢ç©ï¼ˆåªï¼‰ï¼š${aiPrediction.calculation_details?.area_in_tsubo || 'N/A'}åª
â€¢ ç¯‰å¹´æ•°ä¿‚æ•°ï¼š${aiPrediction.calculation_details?.age_factor || 'N/A'}
â€¢ å¸‚å ´ä¿‚æ•°ï¼š${aiPrediction.calculation_details?.market_factor || 'N/A'}
â€¢ èª¿æ•´å¾Œã¡å˜ä¾¡ï¼š${aiPrediction.calculation_details?.adjusted_price_per_sqm || 'N/A'}ä¸‡å††/ã¡

ğŸ¯ ã‚¢ãƒ‰ãƒã‚¤ã‚¹
â€¢ ${aiPrediction.reasoning}
â€¢ é©åˆ‡ãªä¾¡æ ¼è¨­å®šãŒé‡è¦
â€¢ å°‚é–€å®¶ã¸ã®ç›¸è«‡ã‚’ãŠå‹§ã‚ã—ã¾ã™`;

      console.log('ğŸ“ æœ€çµ‚çš„ãªsummary:', summary);
      return { summary, detailed };
    }

  // äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ï¼ˆæ—¢å­˜ï¼‰
  async function handleAppointmentRequest(userId, message) {
    return `ğŸ“… ç›¸è«‡äºˆç´„ã®ã”ä¾é ¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

ä»¥ä¸‹ã®æ–¹æ³•ã§äºˆç´„ã‚’ãŠå–ã‚Šã§ãã¾ã™ï¼š

1ï¸âƒ£ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³äºˆç´„ã‚·ã‚¹ãƒ†ãƒ 
2ï¸âƒ£ ãŠé›»è©±ã§ã®äºˆç´„
3ï¸âƒ£ åº—èˆ—ã§ã®ç›´æ¥äºˆç´„

ã”å¸Œæœ›ã®æ–¹æ³•ã‚’ãŠæ•™ãˆãã ã•ã„ã€‚ã¾ãŸã€ã”ç›¸è«‡å†…å®¹ã‚„ã”å¸Œæœ›ã®æ—¥æ™‚ãŒã‚ã‚Œã°ã€ãŠèã‹ã›ãã ã•ã„ã€‚`;
  }

  // æŸ»å®šçµæœè¡¨ç¤ºã‚¹ãƒ†ãƒƒãƒ—
  async function handleResultStep(userId, session, message) {
    if (message.includes('è©³ç´°è¡¨ç¤º')) {
      session.step = 'detailed_view';
      return `ğŸ“Š è©³ç´°æŸ»å®šçµæœ

${session.data.result.detailed}

æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼š

1ï¸âƒ£ ç›¸è«‡äºˆç´„ï¼šã€Œäºˆç´„ã—ãŸã„ã€
2ï¸âƒ£ ç‰©ä»¶æ”¹å–„ææ¡ˆï¼šã€Œæ”¹å–„ææ¡ˆã€
3ï¸âƒ£ å¸‚å ´åˆ†æãƒ¬ãƒãƒ¼ãƒˆï¼šã€Œå¸‚å ´åˆ†æã€
4ï¸âƒ£ ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—è¨­å®šï¼šã€Œãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ã€
5ï¸âƒ£ ã‚„ã‚Šç›´ã—ï¼šã€Œã‚„ã‚Šç›´ã—ã€`;
    }
    
    if (message.includes('äºˆç´„')) {
      session.step = 'appointment';
      return `ğŸ“… ç›¸è«‡äºˆç´„ã®ã”ä¾é ¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

ä»¥ä¸‹ã®æ–¹æ³•ã§äºˆç´„ã‚’ãŠå–ã‚Šã§ãã¾ã™ï¼š

1ï¸âƒ£ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³äºˆç´„ã‚·ã‚¹ãƒ†ãƒ 
2ï¸âƒ£ ãŠé›»è©±ã§ã®äºˆç´„
3ï¸âƒ£ åº—èˆ—ã§ã®ç›´æ¥äºˆç´„

ã”å¸Œæœ›ã®æ–¹æ³•ã‚’ãŠæ•™ãˆãã ã•ã„ã€‚ã¾ãŸã€ã”ç›¸è«‡å†…å®¹ã‚„ã”å¸Œæœ›ã®æ—¥æ™‚ãŒã‚ã‚Œã°ã€ãŠèã‹ã›ãã ã•ã„ã€‚`;
    }

    if (message.includes('æ”¹å–„ææ¡ˆ')) {
      session.step = 'next_action';
      return `ğŸ  ç‰©ä»¶æ”¹å–„ææ¡ˆ

${session.data.result.recommendations}

ã“ã‚Œã‚‰ã®æ”¹å–„ã‚’è¡Œã†ã“ã¨ã§ã€ç‰©ä»¶ä¾¡å€¤ã®å‘ä¸ŠãŒæœŸå¾…ã§ãã¾ã™ã€‚

æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼š
1ï¸âƒ£ ç›¸è«‡äºˆç´„ï¼šã€Œäºˆç´„ã—ãŸã„ã€
2ï¸âƒ£ ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—è¨­å®šï¼šã€Œãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ã€
3ï¸âƒ£ ã‚„ã‚Šç›´ã—ï¼šã€Œã‚„ã‚Šç›´ã—ã€`;
    }

    if (message.includes('å¸‚å ´åˆ†æ')) {
      session.step = 'next_action';
      return `ğŸ“ˆ å¸‚å ´åˆ†æãƒ¬ãƒãƒ¼ãƒˆ

${session.data.result.market_insights}

ç¾åœ¨ã®å¸‚å ´çŠ¶æ³ã¨ä»Šå¾Œã®å‹•å‘ã«ã¤ã„ã¦åˆ†æã„ãŸã—ã¾ã—ãŸã€‚

æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼š
1ï¸âƒ£ ç›¸è«‡äºˆç´„ï¼šã€Œäºˆç´„ã—ãŸã„ã€
2ï¸âƒ£ ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—è¨­å®šï¼šã€Œãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ã€
3ï¸âƒ£ ã‚„ã‚Šç›´ã—ï¼šã€Œã‚„ã‚Šç›´ã—ã€`;
    }

    if (message.includes('ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—')) {
      session.step = 'followup_setting';
      return `â° ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—è¨­å®š

1é€±é–“ä»¥å†…ã«ä»¥ä¸‹ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨­å®šã§ãã¾ã™ï¼š

1ï¸âƒ£ æ¬¡å›æŸ»å®šäºˆå®šï¼šã€Œæ¬¡å›æŸ»å®šã€
2ï¸âƒ£ å¸‚å ´å‹•å‘ãƒ¬ãƒãƒ¼ãƒˆé…ä¿¡ï¼šã€Œãƒ¬ãƒãƒ¼ãƒˆé…ä¿¡ã€
3ï¸âƒ£ ç‰©ä»¶ä¾¡å€¤ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ï¼šã€Œä¾¡å€¤ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã€
4ï¸âƒ£ ç›¸è«‡ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ï¼šã€Œãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã€

ã©ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã”å¸Œæœ›ã§ã™ã‹ï¼Ÿ`;
    }

    return `ğŸ  æŸ»å®šçµæœï¼š${session.data.address}

ğŸ“Š æ¨å®šä¾¡æ ¼ï¼š${session.data.result.price_range}
ğŸ¯ ç”¨é€”ï¼š${session.data.purpose}
ğŸ“ é¢ç©ï¼š${session.data.area}ã¡
ğŸ—ï¸ ç¯‰å¹´æ•°ï¼šç¯‰${session.data.age}å¹´

ğŸ¤– AIåˆ†æã«ã‚ˆã‚‹æŸ»å®šçµæœã§ã™ã€‚
ğŸ“Š åˆ†æå¯¾è±¡ï¼š${session.data.result.nearby_count}ä»¶ã®è¿‘å‚å–å¼•ãƒ‡ãƒ¼ã‚¿

æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼š

â€¢ è©³ç´°è¡¨ç¤ºï¼šã€Œè©³ç´°è¡¨ç¤ºã€
â€¢ ç›¸è«‡äºˆç´„ï¼šã€Œäºˆç´„ã—ãŸã„ã€
â€¢ ç‰©ä»¶æ”¹å–„ææ¡ˆï¼šã€Œæ”¹å–„ææ¡ˆã€
â€¢ å¸‚å ´åˆ†æãƒ¬ãƒãƒ¼ãƒˆï¼šã€Œå¸‚å ´åˆ†æã€
â€¢ ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—è¨­å®šï¼šã€Œãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ã€
â€¢ ã‚„ã‚Šç›´ã—ï¼šã€Œã‚„ã‚Šç›´ã—ã€`;
  }

  // è©³ç´°è¡¨ç¤ºã‚¹ãƒ†ãƒƒãƒ—
  function handleDetailedViewStep(userId, session, message) {
    if (message.includes('ã‚„ã‚Šç›´ã—')) {
      session.step = 'result';
      return `ğŸ“Š è©³ç´°æŸ»å®šçµæœ

${session.data.result.detailed}`;
    }
    return `ğŸ“Š è©³ç´°æŸ»å®šçµæœ

${session.data.result.detailed}`;
  }

  // æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é¸æŠã‚¹ãƒ†ãƒƒãƒ—
  function handleNextActionStep(userId, session, message) {
    if (message.includes('ã‚„ã‚Šç›´ã—')) {
      session.step = 'welcome';
      return getWelcomeMessage();
    }
    return `ä½•ã‹ã”è³ªå•ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠèã‹ã›ãã ã•ã„ã€‚

â€¢ è©³ç´°è¡¨ç¤ºï¼šã€Œè©³ç´°è¡¨ç¤ºã€
â€¢ ç›¸è«‡äºˆç´„ï¼šã€Œäºˆç´„ã—ãŸã„ã€
â€¢ ã‚„ã‚Šç›´ã—ï¼šã€Œã‚„ã‚Šç›´ã—ã€`;
  }

  // äºˆç´„ã‚¹ãƒ†ãƒƒãƒ—
  function handleAppointmentStep(userId, session, message) {
    if (message.includes('ã‚„ã‚Šç›´ã—')) {
      session.step = 'welcome';
      return getWelcomeMessage();
    }
    return `ğŸ“… ç›¸è«‡äºˆç´„ã®ã”ä¾é ¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

ä»¥ä¸‹ã®æ–¹æ³•ã§äºˆç´„ã‚’ãŠå–ã‚Šã§ãã¾ã™ï¼š

1ï¸âƒ£ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³äºˆç´„ã‚·ã‚¹ãƒ†ãƒ 
2ï¸âƒ£ ãŠé›»è©±ã§ã®äºˆç´„
3ï¸âƒ£ åº—èˆ—ã§ã®ç›´æ¥äºˆç´„

ã”å¸Œæœ›ã®æ–¹æ³•ã‚’ãŠæ•™ãˆãã ã•ã„ã€‚ã¾ãŸã€ã”ç›¸è«‡å†…å®¹ã‚„ã”å¸Œæœ›ã®æ—¥æ™‚ãŒã‚ã‚Œã°ã€ãŠèã‹ã›ãã ã•ã„ã€‚`;
  }

  // ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—è¨­å®šã‚¹ãƒ†ãƒƒãƒ—
  function handleFollowupSettingStep(userId, session, message) {
    if (message.includes('ã‚„ã‚Šç›´ã—')) {
      session.step = 'welcome';
      return getWelcomeMessage();
    }
    return `ã”è³ªå•ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚

ã“ã®æŸ»å®šçµæœã¯ã‚ãªãŸã®ä¸å‹•ç”£ã«é–¢ã™ã‚‹å°‚é–€çš„ãªæ„è¦‹ã§ã™ã€‚

ã‚‚ã—ã€ã“ã®æŸ»å®šçµæœã«ã¤ã„ã¦ã•ã‚‰ã«è©³ã—ãçŸ¥ã‚ŠãŸã„ã“ã¨ã‚„ã€
ãã®ä»–ã®è³ªå•ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠç”³ã—ä»˜ã‘ãã ã•ã„ã€‚

ã¾ãŸã€ã“ã®æŸ»å®šçµæœã‚’ã‚ãªãŸã®LINEãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«ä¿å­˜ã—ã¦ã€
ã„ã¤ã§ã‚‚ã”ç¢ºèªã„ãŸã ã‘ã‚‹ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿ

ã€Œã¯ã„ã€ã¨ãŠç­”ãˆãã ã•ã„ã€‚`;
  }

  // ãƒ¢ãƒƒã‚¯AIäºˆæ¸¬ç”Ÿæˆï¼ˆä¿®æ­£ç‰ˆï¼‰
  function generateMockAIPrediction(data, correctedData) {
    console.log('ğŸ” ãƒ¢ãƒƒã‚¯AIäºˆæ¸¬ç”Ÿæˆé–‹å§‹');
    
    // åŸºæœ¬ã¡å˜ä¾¡ã‚’å††ã§å–å¾—
    const baseYenPerM2 = getBasePriceByAddress(data.address); // ä¾‹: 150,000å††/ã¡
    console.log('ğŸ’° åŸºæœ¬ã¡å˜ä¾¡ï¼ˆå††ï¼‰:', baseYenPerM2);
    
    // ç¯‰å¹´æ•°ã«ã‚ˆã‚‹æ¸›ä¾¡ç‡è¨ˆç®—
    const ageFactor = data.age === 0 ? 1.2 : 
                     data.age <= 5 ? 1.15 : 
                     data.age <= 10 ? 1.1 : 
                     data.age <= 20 ? 1.0 : 
                     data.age <= 30 ? 0.9 : 0.8;
    console.log('ğŸ—ï¸ ç¯‰å¹´æ•°ä¿‚æ•°:', ageFactor);
    
    // å¸‚å ´å¤‰å‹•è¦å› ï¼ˆ0.9ã€œ1.1ï¼‰
    const marketFactor = 0.9 + Math.random() * 0.2;
    console.log('ğŸ“ˆ å¸‚å ´ä¿‚æ•°:', marketFactor);
    
    // èª¿æ•´å¾Œã¡å˜ä¾¡ã‚’å††ã§è¨ˆç®—
    const adjYenPerM2 = Math.round(baseYenPerM2 * ageFactor * marketFactor); // å††/ã¡
    console.log('ğŸ”§ èª¿æ•´å¾Œã¡å˜ä¾¡ï¼ˆå††ï¼‰:', adjYenPerM2);
    
    // ç·ä¾¡æ ¼ã‚’å††ã§è¨ˆç®—
    const medianYen = adjYenPerM2 * data.area; // å††
    const lowYen = Math.round(medianYen * 0.9);
    const highYen = Math.round(medianYen * 1.1);
    console.log('ğŸ’µ ä¾¡æ ¼è¨ˆç®—çµæœï¼ˆå††ï¼‰:', { medianYen, lowYen, highYen });
    
    // å˜ä¾¡ã‚’ä¸‡å††ã§è¡¨ç¤ºç”¨ã«è¨ˆç®—
    const manPerM2 = Math.round((adjYenPerM2 / 10000) * 10) / 10; // ä¸‡å††/ã¡
    const manPerTsubo = Math.round((adjYenPerM2 * 3.305785 / 10000) * 10) / 10; // ä¸‡å††/åª
    console.log('ğŸ“ å˜ä¾¡è¨ˆç®—çµæœ:', { manPerM2, manPerTsubo });
    
    const result = {
      price_low_yen: lowYen,
      price_high_yen: highYen,
      unit_man_per_m2: manPerM2,
      unit_man_per_tsubo: manPerTsubo,
      market_trend: Math.random() > 0.5 ? 'ä¸Šæ˜‡å‚¾å‘' : 'å®‰å®š',
      confidence: 'ä¸­',
      reasoning: 'è¿‘å‚å–å¼•ã®ä¸­å¤®å€¤ã¨ä¿‚æ•°è£œæ­£ã‚’åæ˜ ',
      nearby_count: correctedData.length,
      analysis_period: 'éå»1å¹´',
      radius: '2kmä»¥å†…',
      calculation_details: {
        base_price_per_sqm: Math.floor(baseYenPerM2 / 10000), // ä¸‡å††/ã¡ã«å¤‰æ›
        area_in_tsubo: data.area / 3.305785,
        age_factor: Math.round(ageFactor * 100) / 100,
        market_factor: Math.round(marketFactor * 100) / 100,
        adjusted_price_per_sqm: Math.floor(adjYenPerM2 / 10000)
      }
    };
    
    console.log('ğŸ¯ ãƒ¢ãƒƒã‚¯AIäºˆæ¸¬çµæœ:', result);
    return result;
  }

  // ãƒœã‚¿ãƒ³ä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
  function createButtonMessage(title, text, actions) {
    return {
      type: 'template',
      altText: title,
      template: {
        type: 'buttons',
        title: title,
        text: text,
        actions: actions
      }
    };
  }

  // Flex Messageç”Ÿæˆ
  function createFlexMessage(altText, contents) {
    return {
      type: 'flex',
      altText: altText,
      contents: contents
    };
  }

  // ä½æ‰€é¸æŠãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  function createAddressSelectionMessage() {
    return {
      type: 'template',
      altText: 'ä½æ‰€ã‚’é¸æŠã—ã¦ãã ã•ã„',
      template: {
        type: 'buttons',
        title: 'ğŸ“ ä½æ‰€ã‚’é¸æŠã—ã¦ãã ã•ã„',
        text: 'éƒ½é“åºœçœŒã‚’é¸æŠã™ã‚‹ã‹ã€ç›´æ¥ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',
        actions: [
          { type: 'message', label: 'ğŸ™ï¸ æ±äº¬éƒ½', text: 'æ±äº¬éƒ½æ–°å®¿åŒºè¥¿æ–°å®¿1-1-1' },
          { type: 'message', label: 'ğŸ™ï¸ å¤§é˜ªåºœ', text: 'å¤§é˜ªå¸‚åŒ—åŒºæ¢…ç”°1-1-1' },
          { type: 'message', label: 'ğŸ™ï¸ æ„›çŸ¥çœŒ', text: 'åå¤å±‹å¸‚ä¸­åŒºæ „1-1-1' },
          { type: 'message', label: 'ğŸ™ï¸ ç¦å²¡çœŒ', text: 'ç¦å²¡å¸‚åšå¤šåŒºåšå¤šé§…å‰1-1-1' },
          { type: 'message', label: 'ğŸ™ï¸ åºƒå³¶çœŒ', text: 'åºƒå³¶å¸‚ä¸­åŒºå…«ä¸å €1-1-1' }
        ]
      }
    };
  }

  // é¢ç©é¸æŠãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  function createAreaSelectionMessage() {
    return {
      type: 'template',
      altText: 'é¢ç©ã‚’é¸æŠã—ã¦ãã ã•ã„',
      template: {
        type: 'buttons',
        title: 'ğŸ“ é¢ç©ã‚’é¸æŠã—ã¦ãã ã•ã„',
        text: 'ã‚ˆãã‚ã‚‹é¢ç©ã‚’é¸æŠã™ã‚‹ã‹ã€ç›´æ¥å…¥åŠ›ã—ã¦ãã ã•ã„',
        actions: [
          { type: 'message', label: 'ğŸ  50ã¡', text: '50' },
          { type: 'message', label: 'ğŸ  70ã¡', text: '70' },
          { type: 'message', label: 'ğŸ  100ã¡', text: '100' },
          { type: 'message', label: 'ğŸ  120ã¡', text: '120' },
          { type: 'message', label: 'ğŸ  150ã¡', text: '150' }
        ]
      }
    };
  }

  // ç¯‰å¹´æ•°é¸æŠãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  function createAgeSelectionMessage() {
    return {
      type: 'template',
      altText: 'ç¯‰å¹´æ•°ã‚’é¸æŠã—ã¦ãã ã•ã„',
      template: {
        type: 'buttons',
        title: 'ğŸ—ï¸ ç¯‰å¹´æ•°ã‚’é¸æŠã—ã¦ãã ã•ã„',
        text: 'ç¯‰å¹´æ•°ã‚’é¸æŠã—ã¦ãã ã•ã„',
        actions: [
          { type: 'message', label: 'ğŸ†• æ–°ç¯‰', text: 'æ–°ç¯‰' },
          { type: 'message', label: 'ğŸ  ç¯‰5å¹´ä»¥å†…', text: '5' },
          { type: 'message', label: 'ğŸ  ç¯‰10å¹´ä»¥å†…', text: '10' },
          { type: 'message', label: 'ğŸ  ç¯‰20å¹´ä»¥å†…', text: '20' },
          { type: 'message', label: 'ğŸ  ç¯‰30å¹´ä»¥å†…', text: '30' }
        ]
      }
    };
  }

  // ç”¨é€”é¸æŠãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  function createPurposeSelectionMessage() {
    return {
      type: 'template',
      altText: 'ç”¨é€”ã‚’é¸æŠã—ã¦ãã ã•ã„',
      template: {
        type: 'buttons',
        title: 'ğŸ¯ ç”¨é€”ã‚’é¸æŠã—ã¦ãã ã•ã„',
        text: 'ç‰©ä»¶ã®ç”¨é€”ã‚’é¸æŠã—ã¦ãã ã•ã„',
        actions: [
          { type: 'message', label: 'ğŸ’° å£²å´', text: 'å£²å´' },
          { type: 'message', label: 'ğŸ  è³¼å…¥', text: 'è³¼å…¥' },
          { type: 'message', label: 'ğŸ”‘ è³ƒè²¸', text: 'è³ƒè²¸' }
        ]
      }
    };
  }

  // æŸ»å®šçµæœã®Flex Message
  function createAppraisalResultFlexMessage(data, result) {
    return createFlexMessage(
      'æŸ»å®šçµæœ',
      {
        type: 'bubble',
        size: 'kilo',
        header: {
          type: 'box',
          layout: 'vertical',
          contents: [
            {
              type: 'text',
              text: 'ğŸ  æŸ»å®šå®Œäº†ï¼',
              weight: 'bold',
              size: 'lg',
              color: '#1DB446'
            }
          ]
        },
        body: {
          type: 'box',
          layout: 'vertical',
          spacing: 'md',
          contents: [
            {
              type: 'box',
              layout: 'horizontal',
              contents: [
                { type: 'text', text: 'ğŸ“ ä½æ‰€', size: 'sm', color: '#666666', flex: 2 },
                { type: 'text', text: data.address, size: 'sm', wrap: true, flex: 3 }
              ]
            },
            {
              type: 'box',
              layout: 'horizontal',
              contents: [
                { type: 'text', text: 'ğŸ“Š æ¨å®šä¾¡æ ¼', size: 'sm', color: '#666666', flex: 2 },
                { type: 'text', text: result.summary.match(/æ¨å®šä¾¡æ ¼ï¼š(.+)/)?.[1] || 'è¨ˆç®—ä¸­...', size: 'sm', wrap: true, flex: 3, weight: 'bold' }
              ]
            },
            {
              type: 'box',
              layout: 'horizontal',
              contents: [
                { type: 'text', text: 'ğŸ“ é¢ç©', size: 'sm', color: '#666666', flex: 2 },
                { type: 'text', text: `${data.area}ã¡`, size: 'sm', flex: 3 }
              ]
            },
            {
              type: 'box',
              layout: 'horizontal',
              contents: [
                { type: 'text', text: 'ğŸ—ï¸ ç¯‰å¹´æ•°', size: 'sm', color: '#666666', flex: 2 },
                { type: 'text', text: data.age === 0 ? 'æ–°ç¯‰' : `ç¯‰${data.age}å¹´`, size: 'sm', flex: 3 }
              ]
            }
          ]
        },
        footer: {
          type: 'box',
          layout: 'vertical',
          spacing: 'sm',
          contents: [
            {
              type: 'button',
              style: 'primary',
              action: {
                type: 'message',
                label: 'ğŸ“Š è©³ç´°è¡¨ç¤º',
                text: 'è©³ç´°è¡¨ç¤º'
              },
              color: '#1DB446'
            },
            {
              type: 'button',
              style: 'secondary',
              action: {
                type: 'message',
                label: 'ğŸ“… ç›¸è«‡äºˆç´„',
                text: 'äºˆç´„ã—ãŸã„'
              }
            },
            {
              type: 'button',
              style: 'secondary',
              action: {
                type: 'message',
                label: 'ğŸ”„ ã‚„ã‚Šç›´ã—',
                text: 'ã‚„ã‚Šç›´ã—'
              }
            }
          ]
        }
      }
    );
  }

  console.log('âœ… LINE BotãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸ');
} else {
  console.log('âš ï¸ LINE Botã¯ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ï¼ˆç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèªï¼‰');
}

// â¹ ã“ã“ã‹ã‚‰é€šå¸¸ã® body-parser ã‚’é©ç”¨ï¼ˆ/webhook ã«ã¯å½±éŸ¿ã—ãªã„ï¼‰
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true }));

// âº ãƒ«ãƒ¼ãƒˆ
app.use('/api/auth', authRoutes);
app.use('/api/appraise', appraisalRoutes);
app.use('/api/appointment', appointmentRoutes);
app.use('/api/pdf', pdfRoutes);
app.use('/api/lead', leadRoutes);
app.use('/api/ai', aiRoutes);
app.use('/api/google', googleRoutes);

// ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
app.get('/health', (req, res) => {
  res.json({ 
    status: 'OK', 
    timestamp: new Date().toISOString(),
    message: 'äºŒå®®ä¸å‹•ç”£æŸ»å®šã‚·ã‚¹ãƒ†ãƒ API'
  });
});

// ãƒ«ãƒ¼ãƒˆã®è¡¨ç¤º
function printRoutes(app, prefix = "") {
  const stack = app._router?.stack || [];
  for (const layer of stack) {
    if (layer.route) {
      const methods = Object.keys(layer.route.methods).map(m=>m.toUpperCase()).join(",");
      console.log("ROUTE:", methods, prefix + layer.route.path);
    } else if (layer.name === 'router' && layer.handle?.stack) {
      const base = layer.regexp?.fast_star || layer.regexp?.fast_slash
        ? prefix
        : prefix + (layer.regexp?.toString()
            .replace(/^\/\^\\\//, "/")
            .replace(/\\\/\?\(\?=\\\/\|\$\)\/i$/, "")
            .replace(/\\\//g, "/") || "");
      layer.handle.stack.forEach(r => {
        if (r.route) {
          const methods = Object.keys(r.route.methods).map(m=>m.toUpperCase()).join(",");
          console.log("ROUTE:", methods, base + r.route.path);
        }
      });
    }
  }
}

// â» 404 ã¯æœ€å¾Œã«
app.use((req, res) => {
  res.status(404).json({ error: 'Route not found', path: req.originalUrl });
});

// ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
app.listen(PORT, async () => {
  console.log('ğŸš€ äºŒå®®ä¸å‹•ç”£æŸ»å®šã‚·ã‚¹ãƒ†ãƒ API ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ä¸­...');
  console.log(`ğŸ“ ãƒãƒ¼ãƒˆ: ${PORT}`);
  console.log(`ğŸŒ ç’°å¢ƒ: ${process.env.NODE_ENV || 'development'}`);
  console.log(`ğŸ“Š ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯: http://localhost:${PORT}/health`);
  console.log(`ğŸ¤– AIæ©Ÿèƒ½: http://localhost:${PORT}/api/ai/health`);

  // LINE Botã®ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¨­å®šï¼ˆä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ï¼‰
  // if (lineClient) {
  //   try {
  //     await setupRichMenu();
  //   } catch (error) {
  //     console.error('âŒ ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼:', error);
  //   }
  // }

  // ãƒ«ãƒ¼ãƒˆã®è¡¨ç¤º
  printRoutes(app);
});

ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã‹ã‚‰ãŠé¸ã³ãã ã•ã„ï¼š
â€¢ å£²å´
â€¢ è³¼å…¥
â€¢ è³ƒè²¸

ã©ã®ã‚ˆã†ãªç›®çš„ã§æŸ»å®šã‚’ã”å¸Œæœ›ã§ã—ã‚‡ã†ã‹ï¼Ÿ`;
      }
  
        if (message.length < 2) {
        return `ğŸ‘¤ ã‚‚ã†å°‘ã—è©³ã—ã„ãŠåå‰ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

ä¾‹ï¼šå±±ç”°å¤ªéƒã€ä½è—¤èŠ±å­

ã‚‚ã†å°‘ã—è©³ã—ãæ•™ãˆã¦ã„ãŸã ã‘ã‚‹ã¨åŠ©ã‹ã‚Šã¾ã™ã€‚`;
      }
  
  // åå‰ã‚’ä¿å­˜ã—ã¦æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€
  session.data.name = message;
  session.step = 'phone_input';
  userSessions.set(userId, session);
  
  console.log(`âœ… åå‰ä¿å­˜: ${message}, ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°: name_input â†’ phone_input`);
  
      return `ğŸ“± æ¬¡ã«**é›»è©±ç•ªå·**ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

ä¾‹ï¼š
â€¢ 090-1234-5678
â€¢ 080-9876-5432
â€¢ 03-1234-5678

é›»è©±ç•ªå·ã‚’ãŠæ•™ãˆãã ã•ã„ã€‚`;
}

// é›»è©±ç•ªå·å…¥åŠ›ã‚¹ãƒ†ãƒƒãƒ—
function handlePhoneInputStep(userId, message, session) {
  if (message.includes('ã‚„ã‚Šç›´ã—')) {
    session.step = 'name_input';
    return `ï¿½ï¿½ ãŠåå‰ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚

ä¾‹ï¼šå±±ç”°å¤ªéƒã€ä½è—¤èŠ±å­

ãŠåå‰ã‚’ãŠæ•™ãˆãã ã•ã„ã€‚`;
  }
  
  // é›»è©±ç•ªå·ã®å½¢å¼ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“ç‰ˆï¼‰
  const phonePattern = /[\d\-\(\)\s]{10,}/;
        if (!phonePattern.test(message)) {
        return `ğŸ“± æ­£ã—ã„é›»è©±ç•ªå·ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

ä¾‹ï¼š
â€¢ 090-1234-5678
â€¢ 080-9876-5432
â€¢ 03-1234-5678

ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã­ã€‚`;
      }
  
  // é›»è©±ç•ªå·ã‚’ä¿å­˜ã—ã¦æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€
  session.data.phone = message;
  session.step = 'email_input';
  userSessions.set(userId, session);
  
  console.log(`âœ… é›»è©±ç•ªå·ä¿å­˜: ${message}, ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°: phone_input â†’ email_input`);
  
      return `ğŸ“§ æœ€å¾Œã«**ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹**ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

ä¾‹ï¼š
â€¢ example@email.com
â€¢ test123@gmail.com
â€¢ user@company.co.jp

ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãŠæ•™ãˆãã ã•ã„ã€‚
ï¼ˆå¿…é ˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹å ´åˆã¯ã€Œã‚¹ã‚­ãƒƒãƒ—ã€ã¨ãŠé€ã‚Šãã ã•ã„ï¼‰`;
}

// ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›ã‚¹ãƒ†ãƒƒãƒ—
function handleEmailInputStep(userId, message, session) {
  if (message.includes('ã‚„ã‚Šç›´ã—')) {
    session.step = 'phone_input';
    return `ğŸ“± é›»è©±ç•ªå·ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

ä¾‹ï¼š
â€¢ 090-1234-5678
â€¢ 080-9876-5432
â€¢ 03-1234-5678

é›»è©±ç•ªå·ã‚’ãŠæ•™ãˆãã ã•ã„ã€‚`;
  }
  
  if (message.includes('ã‚¹ã‚­ãƒƒãƒ—') || message.includes('skip')) {
    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚¹ã‚­ãƒƒãƒ—
    session.data.email = null;
    console.log(`âœ… ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚¹ã‚­ãƒƒãƒ—, ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°: email_input â†’ personal_info`);
    
    // å€‹äººæƒ…å ±å…¥åŠ›å®Œäº†ã€è‡ªå‹•æŸ»å®šé–‹å§‹
    return completePersonalInfoAndStartAppraisal(userId, session);
  }
  
  // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“ç‰ˆï¼‰
  const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailPattern.test(message)) {
        return `ğŸ“§ æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

ä¾‹ï¼š
â€¢ example@email.com
â€¢ test123@gmail.com
â€¢ user@company.co.jp

ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã­ã€‚
ï¼ˆå¿…é ˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹å ´åˆã¯ã€Œã‚¹ã‚­ãƒƒãƒ—ã€ã¨ãŠé€ã‚Šãã ã•ã„ï¼‰`;
      }
  
  // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¿å­˜
  session.data.email = message;
  console.log(`âœ… ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ä¿å­˜: ${message}, ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°: email_input â†’ personal_info`);
  
  // å€‹äººæƒ…å ±å…¥åŠ›å®Œäº†ã€è‡ªå‹•æŸ»å®šé–‹å§‹
  return completePersonalInfoAndStartAppraisal(userId, session);
}

// å€‹äººæƒ…å ±å…¥åŠ›å®Œäº†ã¨æŸ»å®šé–‹å§‹
async function completePersonalInfoAndStartAppraisal(userId, session) {
  try {
    // Supabaseã«å€‹äººæƒ…å ±ã‚’ä¿å­˜
    const { supabaseAdmin } = require('./config/database');
    const { data: owner, error } = await supabaseAdmin
      .from('owners')
      .upsert({
        line_user_id: userId,
        name: session.data.name,
        phone: session.data.phone,
        email: session.data.email,
        consent_given: true,
        last_activity: new Date().toISOString()
      }, {
        onConflict: 'line_user_id'
      })
      .select()
      .single();

    if (error) {
      console.error('å€‹äººæƒ…å ±ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      return `âŒ ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚å€‹äººæƒ…å ±ã®ä¿å­˜ã«å¤±æ•—ã„ãŸã—ã¾ã—ãŸã€‚

ã‚‚ã†ä¸€åº¦æœ€åˆã‹ã‚‰å…¥åŠ›ã—ã¦ã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ã€‚
ã€Œã‚„ã‚Šç›´ã—ã€ã¨ãŠé€ã‚Šãã ã•ã„ã€‚`;
    }

    console.log('âœ… å€‹äººæƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ:', owner.id);
    
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«å€‹äººæƒ…å ±ã‚’ä¿å­˜
    session.data.owner_id = owner.id;
    session.step = 'result';
    
    // è‡ªå‹•çš„ã«æŸ»å®šã‚’é–‹å§‹
    try {
      console.log(`ğŸ¤– è‡ªå‹•æŸ»å®šé–‹å§‹: ${session.data.address}`);
      
      // å®Ÿéš›ã®æŸ»å®šAPIã‚’å‘¼ã³å‡ºã—
      const appraisalResult = await executeAppraisal(session.data);
      session.data.result = appraisalResult;
      userSessions.set(userId, session);
      
      return `âœ… å€‹äººæƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼

ğŸ¤– AIæŸ»å®šã‚’é–‹å§‹ã—ã¾ã™ï¼

${session.data.address}ã®${session.data.area}ã¡ã€ç¯‰${session.data.age}å¹´ã®ç‰©ä»¶ã‚’${session.data.purpose}ç›®çš„ã§æŸ»å®šã„ãŸã—ã¾ã™ã€‚

ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...

ğŸ“Š æŸ»å®šå®Œäº†ï¼

${appraisalResult.summary}

è©³ç´°ãªçµæœã‚’è¦‹ã‚‹ã«ã¯ã€Œè©³ç´°è¡¨ç¤ºã€ã¨ãŠé€ã‚Šãã ã•ã„ã€‚
ç›¸è«‡äºˆç´„ã‚’ã”å¸Œæœ›ã®å ´åˆã¯ã€Œäºˆç´„ã—ãŸã„ã€ã¨ãŠé€ã‚Šãã ã•ã„ã€‚
ã‚„ã‚Šç›´ã—ã®å ´åˆã¯ã€Œã‚„ã‚Šç›´ã—ã€ã¨ãŠé€ã‚Šãã ã•ã„ã€‚`;
      
    } catch (error) {
      console.error('æŸ»å®šã‚¨ãƒ©ãƒ¼:', error);
      session.step = 'result';
      userSessions.set(userId, session);
      return `âœ… å€‹äººæƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼

âŒ æŸ»å®šå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

ã‚‚ã†ä¸€åº¦æŸ»å®šã‚’é–‹å§‹ã™ã‚‹ã«ã¯ã€Œã‚„ã‚Šç›´ã—ã€ã¨ãŠé€ã‚Šãã ã•ã„ã€‚`;
    }
    
  } catch (error) {
    console.error('å€‹äººæƒ…å ±ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
          return `âŒ ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚å€‹äººæƒ…å ±ã®ä¿å­˜ã«å¤±æ•—ã„ãŸã—ã¾ã—ãŸã€‚

ã‚‚ã†ä¸€åº¦æœ€åˆã‹ã‚‰å…¥åŠ›ã—ã¦ã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ã€‚
ã€Œã‚„ã‚Šç›´ã—ã€ã¨ãŠé€ã‚Šãã ã•ã„ã€‚`;
  }
}

